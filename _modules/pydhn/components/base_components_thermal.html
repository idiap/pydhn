

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pydhn.components.base_components_thermal &mdash; PyDHN 0.1.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=360bc84d"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            PyDHN
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Install PyDHN:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install/install.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Get started:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/network.html">The Network class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/fluids.html">Fluids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/soil.html">Soils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/simulation.html">Simulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../get_started/loops.html">Loops</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/pydhn.html">pydhn</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/references.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyDHN</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pydhn.components.base_components_thermal</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pydhn.components.base_components_thermal</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="c1"># SPDX-FileCopyrightText: Copyright © 2023 Idiap Research Institute, EPFL</span>
<span class="c1">#</span>
<span class="c1"># SPDX-FileContributor: Roberto Boghetti &lt;roberto.boghetti@idiap.ch&gt;</span>
<span class="c1">#</span>
<span class="c1"># SPDX-License-Identifier: AGPL-3.0-only</span>


<span class="sd">&quot;&quot;&quot;Functions to compute average and outlet temperature for base components&quot;&quot;&quot;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">CP_FLUID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEPTH</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">DISCRETIZATION</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">K_CASING</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">K_FLUID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">K_INTERNAL_PIPE</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">K_SOIL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">MU_FLUID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">RHO_FLUID</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.default_values</span><span class="w"> </span><span class="kn">import</span> <span class="n">T_SOIL</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.fluids.dimensionless_numbers</span><span class="w"> </span><span class="kn">import</span> <span class="n">compute_nusselt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">isiter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">np_cache</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydhn.utilities</span><span class="w"> </span><span class="kn">import</span> <span class="n">safe_divide</span>

<span class="c1"># Functions are divided by element type. For each element, the upper section</span>
<span class="c1"># contains generic functions that work with Numpy arrays. Functions that need a</span>
<span class="c1"># Network object and a Fluid object are instead in the second section.</span>


<span class="c1"># --------                         Base pipe                         -------- #</span>


<span class="nd">@np_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_compute_convection_resistance</span><span class="p">(</span>
    <span class="n">diameter</span><span class="p">,</span>
    <span class="n">reynolds</span><span class="p">,</span>
    <span class="n">length</span><span class="p">,</span>
    <span class="n">friction_factor</span><span class="p">,</span>
    <span class="n">cp_fluid</span><span class="o">=</span><span class="n">CP_FLUID</span><span class="p">,</span>
    <span class="n">mu_fluid</span><span class="o">=</span><span class="n">MU_FLUID</span><span class="p">,</span>
    <span class="n">k_fluid</span><span class="o">=</span><span class="n">K_FLUID</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the thermal resistance due to internal convection.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nu</span> <span class="o">=</span> <span class="n">compute_nusselt</span><span class="p">(</span>
        <span class="n">reynolds</span><span class="o">=</span><span class="n">reynolds</span><span class="p">,</span>
        <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
        <span class="n">friction_factor</span><span class="o">=</span><span class="n">friction_factor</span><span class="p">,</span>
        <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
        <span class="n">mu_fluid</span><span class="o">=</span><span class="n">mu_fluid</span><span class="p">,</span>
        <span class="n">k_fluid</span><span class="o">=</span><span class="n">k_fluid</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">k_fluid</span> <span class="o">*</span> <span class="n">nu</span><span class="p">,</span> <span class="n">diameter</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_layer_resistance</span><span class="p">(</span><span class="n">r_1</span><span class="p">,</span> <span class="n">r_2</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the thermal resistance of a single layer in a circular pipe.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    r_1 : array, float</span>
<span class="sd">        Radius [m] of the innermost surface of the layer.</span>
<span class="sd">    r_2 : array, float</span>
<span class="sd">        Radius [m] of the outermost surface of the layer..</span>
<span class="sd">    k : array, float</span>
<span class="sd">        Thermal conductivity [W/(K·m)] of the layer material.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array, float</span>
<span class="sd">        Thermal resistance [(K·m)/W] of the layer.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">r_1</span> <span class="o">&gt;</span> <span class="n">r_2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Error: the inner radius should be greater than the </span><span class="se">\</span>
<span class="s2">                         outer radius!&quot;</span>
        <span class="p">)</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">safe_divide</span><span class="p">(</span><span class="n">r_2</span><span class="p">,</span> <span class="n">r_1</span><span class="p">))</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">return</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">denom</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_soil_resistance</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">rad_ext</span><span class="p">,</span> <span class="n">k_soil</span><span class="o">=</span><span class="n">K_SOIL</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">rad_ext</span><span class="p">)</span>
    <span class="c1"># depth &gt; 3r</span>
    <span class="n">res_soil_1</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">x</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">3.14</span> <span class="o">*</span> <span class="n">k_soil</span><span class="p">)</span>
    <span class="c1"># depth &lt;= 3r</span>
    <span class="n">res_soil_2</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)),</span> <span class="mi">2</span> <span class="o">*</span> <span class="mf">3.14</span> <span class="o">*</span> <span class="n">k_soil</span><span class="p">)</span>
    <span class="n">res_soil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">rad_ext</span><span class="p">,</span> <span class="n">res_soil_1</span><span class="p">,</span> <span class="n">res_soil_2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res_soil</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_pipe_outlet_temp</span><span class="p">(</span>
    <span class="n">t_in</span><span class="p">,</span>
    <span class="n">mdot</span><span class="p">,</span>
    <span class="n">length</span><span class="p">,</span>
    <span class="n">diameter</span><span class="p">,</span>
    <span class="n">k_insulation</span><span class="p">,</span>
    <span class="n">thickness_ins</span><span class="p">,</span>
    <span class="n">reynolds</span><span class="p">,</span>
    <span class="n">friction_factor</span><span class="p">,</span>
    <span class="n">delta_p_friction</span><span class="p">,</span>
    <span class="n">k_internal_pipe</span><span class="o">=</span><span class="n">K_INTERNAL_PIPE</span><span class="p">,</span>
    <span class="n">thickness_internal_pipe</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k_casing</span><span class="o">=</span><span class="n">K_CASING</span><span class="p">,</span>
    <span class="n">thickness_casing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">t_soil</span><span class="o">=</span><span class="n">T_SOIL</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="n">DEPTH</span><span class="p">,</span>
    <span class="n">k_soil</span><span class="o">=</span><span class="n">K_SOIL</span><span class="p">,</span>
    <span class="n">cp_fluid</span><span class="o">=</span><span class="n">CP_FLUID</span><span class="p">,</span>
    <span class="n">mu_fluid</span><span class="o">=</span><span class="n">MU_FLUID</span><span class="p">,</span>
    <span class="n">k_fluid</span><span class="o">=</span><span class="n">K_FLUID</span><span class="p">,</span>
    <span class="n">rho_fluid</span><span class="o">=</span><span class="n">RHO_FLUID</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes the outlet temperature of a pipe from the inlet temperature&quot;&quot;&quot;</span>
    <span class="c1"># Mass flow must be positive, as the direction is assumed the same as the</span>
    <span class="c1"># pipe reference frame</span>
    <span class="n">mdot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mdot</span><span class="p">)</span>

    <span class="c1"># Compute radii</span>
    <span class="n">rad_1</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># Internal radius</span>
    <span class="n">rad_2</span> <span class="o">=</span> <span class="n">rad_1</span> <span class="o">+</span> <span class="n">thickness_internal_pipe</span>  <span class="c1"># Pipe external radius</span>
    <span class="n">rad_3</span> <span class="o">=</span> <span class="n">rad_2</span> <span class="o">+</span> <span class="n">thickness_ins</span>  <span class="c1"># Insulation external radius</span>
    <span class="n">rad_4</span> <span class="o">=</span> <span class="n">rad_3</span> <span class="o">+</span> <span class="n">thickness_casing</span>  <span class="c1"># External radius</span>

    <span class="c1"># Compute pipe thermal resistances</span>
    <span class="n">res_1_2</span> <span class="o">=</span> <span class="n">_compute_layer_resistance</span><span class="p">(</span><span class="n">rad_1</span><span class="p">,</span> <span class="n">rad_2</span><span class="p">,</span> <span class="n">k_internal_pipe</span><span class="p">)</span>
    <span class="n">res_2_3</span> <span class="o">=</span> <span class="n">_compute_layer_resistance</span><span class="p">(</span><span class="n">rad_2</span><span class="p">,</span> <span class="n">rad_3</span><span class="p">,</span> <span class="n">k_insulation</span><span class="p">)</span>
    <span class="n">res_3_4</span> <span class="o">=</span> <span class="n">_compute_layer_resistance</span><span class="p">(</span><span class="n">rad_3</span><span class="p">,</span> <span class="n">rad_4</span><span class="p">,</span> <span class="n">k_casing</span><span class="p">)</span>

    <span class="c1"># Compute soil resistance</span>
    <span class="n">res_soil</span> <span class="o">=</span> <span class="n">_compute_soil_resistance</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span> <span class="n">rad_ext</span><span class="o">=</span><span class="n">rad_4</span><span class="p">,</span> <span class="n">k_soil</span><span class="o">=</span><span class="n">k_soil</span><span class="p">)</span>

    <span class="c1"># Convection resistance</span>
    <span class="n">h_convection</span> <span class="o">=</span> <span class="n">_compute_convection_resistance</span><span class="p">(</span>
        <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
        <span class="n">reynolds</span><span class="o">=</span><span class="n">reynolds</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
        <span class="n">friction_factor</span><span class="o">=</span><span class="n">friction_factor</span><span class="p">,</span>
        <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
        <span class="n">mu_fluid</span><span class="o">=</span><span class="n">mu_fluid</span><span class="p">,</span>
        <span class="n">k_fluid</span><span class="o">=</span><span class="n">k_fluid</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">res_convection</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">h_convection</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">rad_1</span><span class="p">)</span>

    <span class="c1"># Compute losses</span>
    <span class="n">r_tot</span> <span class="o">=</span> <span class="n">res_1_2</span> <span class="o">+</span> <span class="n">res_2_3</span> <span class="o">+</span> <span class="n">res_3_4</span> <span class="o">+</span> <span class="n">res_soil</span> <span class="o">+</span> <span class="n">res_convection</span>
    <span class="n">heat_gain</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">mdot</span><span class="p">,</span> <span class="n">rho_fluid</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">delta_p_friction</span><span class="p">)</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">t_in</span> <span class="o">-</span> <span class="n">t_soil</span><span class="p">)</span> <span class="o">/</span> <span class="n">r_tot</span> <span class="o">*</span> <span class="n">length</span>

    <span class="c1"># If the fluid velocity is close to 0, the fluid is considered still and</span>
    <span class="c1"># there is no friction</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">loss</span> <span class="o">&gt;</span> <span class="n">heat_gain</span><span class="p">,</span> <span class="n">loss</span> <span class="o">-</span> <span class="n">heat_gain</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
    <span class="n">t_out</span> <span class="o">=</span> <span class="n">t_in</span> <span class="o">-</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">mdot</span> <span class="o">*</span> <span class="n">cp_fluid</span><span class="p">)</span>
    <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">t_soil</span> <span class="o">&lt;</span> <span class="n">t_in</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="n">t_soil</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">t_soil</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mdot</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">t_soil</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span>

    <span class="n">t_out_der</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">mdot</span> <span class="o">*</span> <span class="n">cp_fluid</span> <span class="o">*</span> <span class="n">r_tot</span><span class="p">)</span>
    <span class="n">t_out_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mdot</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">)</span>
    <span class="n">t_out_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t_out</span> <span class="o">&lt;=</span> <span class="n">t_soil</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_out_der</span>


<div class="viewcode-block" id="compute_pipe_temp">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_pipe_temp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_pipe_temp</span><span class="p">(</span>
    <span class="n">t_in</span><span class="p">,</span>
    <span class="n">mdot</span><span class="p">,</span>
    <span class="n">length</span><span class="p">,</span>
    <span class="n">diameter</span><span class="p">,</span>
    <span class="n">reynolds</span><span class="p">,</span>
    <span class="n">thickness_ins</span><span class="p">,</span>
    <span class="n">k_insulation</span><span class="p">,</span>
    <span class="n">friction_factor</span><span class="p">,</span>
    <span class="n">delta_p_friction</span><span class="p">,</span>
    <span class="n">k_internal_pipe</span><span class="o">=</span><span class="n">K_INTERNAL_PIPE</span><span class="p">,</span>
    <span class="n">thickness_internal_pipe</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">k_casing</span><span class="o">=</span><span class="n">K_CASING</span><span class="p">,</span>
    <span class="n">thickness_casing</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
    <span class="n">t_soil</span><span class="o">=</span><span class="n">T_SOIL</span><span class="p">,</span>
    <span class="n">depth</span><span class="o">=</span><span class="n">DEPTH</span><span class="p">,</span>
    <span class="n">k_soil</span><span class="o">=</span><span class="n">K_SOIL</span><span class="p">,</span>
    <span class="n">cp_fluid</span><span class="o">=</span><span class="n">CP_FLUID</span><span class="p">,</span>
    <span class="n">mu_fluid</span><span class="o">=</span><span class="n">MU_FLUID</span><span class="p">,</span>
    <span class="n">k_fluid</span><span class="o">=</span><span class="n">K_FLUID</span><span class="p">,</span>
    <span class="n">rho_fluid</span><span class="o">=</span><span class="n">RHO_FLUID</span><span class="p">,</span>
    <span class="n">discretization</span><span class="o">=</span><span class="n">DISCRETIZATION</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the outlet temperature of a pipe from the inlet temperature. The</span>
<span class="sd">    pipe is split into segments of length ~ discretization for better results.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get mass flow sign</span>
    <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">mdot</span><span class="p">)</span>

    <span class="c1"># Get original t_in</span>
    <span class="n">t_in_orig</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>

    <span class="c1"># Split the pipe in n segments of equal length. Segment length should be</span>
    <span class="c1"># as close as possible to the discretization length given.</span>
    <span class="n">n_segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">length</span> <span class="o">//</span> <span class="n">discretization</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">%</span> <span class="n">discretization</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">l_segments</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">n_segments</span><span class="p">)</span>

    <span class="c1"># Initialize empty vector for summing the averages</span>
    <span class="k">if</span> <span class="n">isiter</span><span class="p">(</span><span class="n">n_segments</span><span class="p">):</span>
        <span class="n">t_avg_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">n_segments</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_avg_sum</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">t_out_der_tot</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Distributed pressure losses are considered linear and equally split among</span>
    <span class="c1"># segments</span>
    <span class="n">delta_p_segments</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">delta_p_friction</span><span class="p">,</span> <span class="n">n_segments</span><span class="p">)</span>

    <span class="c1"># Iterate a number of times equal to the maximum number of segments</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">n_segments</span><span class="p">))):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">n_segments</span>
        <span class="c1"># Compute t_out where there are still segments to compute</span>
        <span class="n">t_out</span><span class="p">,</span> <span class="n">t_out_der</span> <span class="o">=</span> <span class="n">_compute_pipe_outlet_temp</span><span class="p">(</span>
            <span class="n">t_in</span><span class="o">=</span><span class="n">t_in</span><span class="p">,</span>
            <span class="n">mdot</span><span class="o">=</span><span class="n">mdot</span> <span class="o">*</span> <span class="n">sign</span><span class="p">,</span>
            <span class="n">length</span><span class="o">=</span><span class="n">l_segments</span><span class="p">,</span>
            <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
            <span class="n">reynolds</span><span class="o">=</span><span class="n">reynolds</span><span class="p">,</span>
            <span class="n">friction_factor</span><span class="o">=</span><span class="n">friction_factor</span><span class="p">,</span>
            <span class="n">delta_p_friction</span><span class="o">=</span><span class="n">delta_p_segments</span><span class="p">,</span>
            <span class="n">thickness_ins</span><span class="o">=</span><span class="n">thickness_ins</span><span class="p">,</span>
            <span class="n">k_insulation</span><span class="o">=</span><span class="n">k_insulation</span><span class="p">,</span>
            <span class="n">k_internal_pipe</span><span class="o">=</span><span class="n">k_internal_pipe</span><span class="p">,</span>
            <span class="n">thickness_internal_pipe</span><span class="o">=</span><span class="n">thickness_internal_pipe</span><span class="p">,</span>
            <span class="n">k_casing</span><span class="o">=</span><span class="n">k_casing</span><span class="p">,</span>
            <span class="n">thickness_casing</span><span class="o">=</span><span class="n">thickness_casing</span><span class="p">,</span>
            <span class="n">t_soil</span><span class="o">=</span><span class="n">t_soil</span><span class="p">,</span>
            <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
            <span class="n">k_soil</span><span class="o">=</span><span class="n">k_soil</span><span class="p">,</span>
            <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
            <span class="n">mu_fluid</span><span class="o">=</span><span class="n">mu_fluid</span><span class="p">,</span>
            <span class="n">k_fluid</span><span class="o">=</span><span class="n">k_fluid</span><span class="p">,</span>
            <span class="n">rho_fluid</span><span class="o">=</span><span class="n">rho_fluid</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">t_out</span><span class="p">)</span>
        <span class="c1"># Add the averages to the total</span>
        <span class="n">t_avg_segments</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">t_in</span> <span class="o">+</span> <span class="n">t_out</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">t_avg_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">t_avg_sum</span><span class="p">,</span> <span class="n">t_avg_sum</span> <span class="o">+</span> <span class="n">t_avg_segments</span><span class="p">)</span>
        <span class="n">t_out_der_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">t_out_der_tot</span><span class="p">,</span> <span class="n">t_out_der_tot</span> <span class="o">*</span> <span class="n">t_out_der</span><span class="p">)</span>
        <span class="c1"># Impose T_out as new T_in</span>
        <span class="n">t_in</span> <span class="o">=</span> <span class="n">t_out</span>

    <span class="c1"># T_avg is the sum of averages divided by the number of segments</span>
    <span class="n">t_avg</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">t_avg_sum</span><span class="p">,</span> <span class="n">n_segments</span><span class="p">)</span>

    <span class="c1"># Compute thermal losses</span>
    <span class="n">delta_q</span> <span class="o">=</span> <span class="n">mdot</span> <span class="o">*</span> <span class="n">cp_fluid</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_out</span> <span class="o">-</span> <span class="n">t_in_orig</span><span class="p">)</span>

    <span class="c1"># Return t_0, t_1 and t_avg</span>
    <span class="k">return</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der_tot</span><span class="p">,</span> <span class="n">delta_q</span></div>



<div class="viewcode-block" id="compute_pipe_temp_net">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_pipe_temp_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_pipe_temp_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Get pipe attributes</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;mass_flow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;diameter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;reynolds&quot;</span><span class="p">,</span>
        <span class="s2">&quot;friction_factor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;delta_p_friction&quot;</span><span class="p">,</span>
        <span class="s2">&quot;depth&quot;</span><span class="p">,</span>
        <span class="s2">&quot;insulation_thickness&quot;</span><span class="p">,</span>
        <span class="s2">&quot;k_insulation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;internal_pipe_thickness&quot;</span><span class="p">,</span>
        <span class="s2">&quot;k_internal_pipe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;casing_thickness&quot;</span><span class="p">,</span>
        <span class="s2">&quot;k_casing&quot;</span><span class="p">,</span>
        <span class="s2">&quot;discretization&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">edges</span><span class="p">,</span>
        <span class="n">mass_flow</span><span class="p">,</span>
        <span class="n">length</span><span class="p">,</span>
        <span class="n">diameter</span><span class="p">,</span>
        <span class="n">reynolds</span><span class="p">,</span>
        <span class="n">friction_factor</span><span class="p">,</span>
        <span class="n">delta_p_friction</span><span class="p">,</span>
        <span class="n">depth</span><span class="p">,</span>
        <span class="n">thickness_ins</span><span class="p">,</span>
        <span class="n">k_insulation</span><span class="p">,</span>
        <span class="n">thickness_internal_pipe</span><span class="p">,</span>
        <span class="n">k_internal_pipe</span><span class="p">,</span>
        <span class="n">thickness_casing</span><span class="p">,</span>
        <span class="n">k_casing</span><span class="p">,</span>
        <span class="n">discretization</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">pipes_mask</span><span class="p">)</span>

    <span class="c1"># Get temperature at startnode and endnode of pipe</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">t_nodes</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nodes_t_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">t_nodes</span><span class="p">))</span>
    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">nodes_t_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">u</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">nodes_t_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">v</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Get inlet temperature according to the flow direction</span>
    <span class="n">t_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mass_flow</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)</span>

    <span class="c1"># Get fluid properties at inlet temperature</span>
    <span class="n">cp_fluid</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">get_cp</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>
    <span class="n">k_fluid</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">get_k</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>
    <span class="n">mu_fluid</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">get_mu</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>
    <span class="n">rho_fluid</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">get_rho</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>

    <span class="c1"># Get soil properties</span>
    <span class="n">k_soil</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">get_k</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>
    <span class="n">t_soil</span> <span class="o">=</span> <span class="n">soil</span><span class="o">.</span><span class="n">get_temp</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">)</span>

    <span class="c1"># Compute t_out</span>
    <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span> <span class="o">=</span> <span class="n">compute_pipe_temp</span><span class="p">(</span>
        <span class="n">t_in</span><span class="o">=</span><span class="n">t_in</span><span class="p">,</span>
        <span class="n">mdot</span><span class="o">=</span><span class="n">mass_flow</span><span class="p">,</span>
        <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span>
        <span class="n">diameter</span><span class="o">=</span><span class="n">diameter</span><span class="p">,</span>
        <span class="n">reynolds</span><span class="o">=</span><span class="n">reynolds</span><span class="p">,</span>
        <span class="n">thickness_ins</span><span class="o">=</span><span class="n">thickness_ins</span><span class="p">,</span>
        <span class="n">k_insulation</span><span class="o">=</span><span class="n">k_insulation</span><span class="p">,</span>
        <span class="n">friction_factor</span><span class="o">=</span><span class="n">friction_factor</span><span class="p">,</span>
        <span class="n">delta_p_friction</span><span class="o">=</span><span class="n">delta_p_friction</span><span class="p">,</span>
        <span class="n">k_internal_pipe</span><span class="o">=</span><span class="n">k_internal_pipe</span><span class="p">,</span>
        <span class="n">thickness_internal_pipe</span><span class="o">=</span><span class="n">thickness_internal_pipe</span><span class="p">,</span>
        <span class="n">k_casing</span><span class="o">=</span><span class="n">k_casing</span><span class="p">,</span>
        <span class="n">thickness_casing</span><span class="o">=</span><span class="n">thickness_casing</span><span class="p">,</span>
        <span class="n">t_soil</span><span class="o">=</span><span class="n">t_soil</span><span class="p">,</span>
        <span class="n">k_soil</span><span class="o">=</span><span class="n">k_soil</span><span class="p">,</span>
        <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
        <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
        <span class="n">mu_fluid</span><span class="o">=</span><span class="n">mu_fluid</span><span class="p">,</span>
        <span class="n">k_fluid</span><span class="o">=</span><span class="n">k_fluid</span><span class="p">,</span>
        <span class="n">rho_fluid</span><span class="o">=</span><span class="n">rho_fluid</span><span class="p">,</span>
        <span class="n">discretization</span><span class="o">=</span><span class="n">discretization</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span></div>



<span class="c1"># --------                Base Consumer and Producer                 -------- #</span>


<span class="c1"># Base Consumers and Producers share the same function for computing the outlet</span>
<span class="c1"># and average temperatures.</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_compute_hx_outlet_temp</span><span class="p">(</span>
    <span class="n">t_in</span><span class="p">,</span>
    <span class="n">mass_flow</span><span class="p">,</span>
    <span class="n">power_max</span><span class="p">,</span>
    <span class="n">t_out_min</span><span class="p">,</span>
    <span class="n">setpoint_type</span><span class="p">,</span>
    <span class="n">setpoint_value</span><span class="p">,</span>
    <span class="n">cp_fluid</span><span class="p">,</span>
    <span class="n">stepsize</span><span class="o">=</span><span class="mf">3600.0</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Mass flow must be positive, as the direction is assumed the same as the</span>
    <span class="c1"># HX reference frame</span>
    <span class="n">mass_flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mass_flow</span><span class="p">)</span>

    <span class="c1"># Find what setpoints are given</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="n">setpoint_type</span> <span class="o">==</span> <span class="s2">&quot;t_out&quot;</span>
    <span class="n">w2</span> <span class="o">=</span> <span class="n">setpoint_type</span> <span class="o">==</span> <span class="s2">&quot;delta_t&quot;</span>
    <span class="n">w3</span> <span class="o">=</span> <span class="n">setpoint_type</span> <span class="o">==</span> <span class="s2">&quot;delta_q&quot;</span>

    <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="c1"># First condition: t_out is imposed</span>
        <span class="n">w1</span><span class="p">,</span>
        <span class="n">setpoint_value</span><span class="p">,</span>
        <span class="c1"># Other conditions:</span>
        <span class="c1"># If delta_t is imposed</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">w2</span><span class="p">,</span>
            <span class="n">t_in</span> <span class="o">+</span> <span class="n">setpoint_value</span><span class="p">,</span>
            <span class="c1"># If delta_q is used</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">w3</span><span class="p">,</span>
                <span class="n">t_in</span>
                <span class="o">+</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">setpoint_value</span> <span class="o">*</span> <span class="mf">3600.0</span><span class="p">,</span> <span class="n">mass_flow</span> <span class="o">*</span> <span class="n">cp_fluid</span> <span class="o">*</span> <span class="n">stepsize</span><span class="p">),</span>
                <span class="c1"># If none of the above, just return the inlet temperature</span>
                <span class="n">t_in</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">t_out_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="c1"># First condition: t_out is imposed</span>
        <span class="n">w1</span><span class="p">,</span>
        <span class="mf">0.0</span><span class="p">,</span>
        <span class="c1"># Other conditions:</span>
        <span class="c1"># If delta_t is imposed</span>
        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">w2</span><span class="p">,</span>
            <span class="mf">1.0</span><span class="p">,</span>
            <span class="c1"># If delta_q is used</span>
            <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">w3</span><span class="p">,</span>
                <span class="mf">1.0</span><span class="p">,</span>
                <span class="c1"># If none of the above, just return the inlet temperature</span>
                <span class="mf">1.0</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># Clip if t_out lower than threshold</span>
    <span class="n">lower_limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">t_out_min</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">t_out_min</span><span class="p">)</span>
    <span class="n">t_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">t_out</span><span class="p">,</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">t_out_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t_out</span> <span class="o">&lt;=</span> <span class="n">lower_limit</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">)</span>

    <span class="c1"># Compute delta_q</span>
    <span class="n">delta_q</span> <span class="o">=</span> <span class="n">mass_flow</span> <span class="o">*</span> <span class="n">cp_fluid</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_out</span> <span class="o">-</span> <span class="n">t_in</span><span class="p">)</span> <span class="o">*</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">stepsize</span><span class="p">,</span> <span class="mf">3600.0</span><span class="p">)</span>

    <span class="c1"># Clip if above max power</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">power_max</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">power_max</span> <span class="o">*</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">stepsize</span><span class="p">,</span> <span class="mf">3600.0</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">delta_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">delta_q</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>

    <span class="c1"># Recompute t_out based on clipped values</span>
    <span class="n">t_out</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">delta_q</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">,</span> <span class="n">mass_flow</span> <span class="o">*</span> <span class="n">cp_fluid</span> <span class="o">*</span> <span class="n">stepsize</span><span class="p">)</span> <span class="o">+</span> <span class="n">t_in</span>

    <span class="k">return</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span>


<div class="viewcode-block" id="compute_hx_temp">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_hx_temp">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_hx_temp</span><span class="p">(</span>
    <span class="n">mass_flow</span><span class="p">,</span>
    <span class="n">t_in</span><span class="p">,</span>
    <span class="n">setpoint_type</span><span class="p">,</span>
    <span class="n">setpoint_type_rev</span><span class="p">,</span>
    <span class="n">setpoint_value</span><span class="p">,</span>
    <span class="n">setpoint_value_rev</span><span class="p">,</span>
    <span class="n">power_max</span><span class="p">,</span>
    <span class="n">t_out_min</span><span class="p">,</span>
    <span class="n">cp_fluid</span><span class="p">,</span>
    <span class="n">stepsize</span><span class="o">=</span><span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="c1"># Get setpoint type and value</span>
    <span class="n">set_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mass_flow</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">setpoint_type</span><span class="p">,</span> <span class="n">setpoint_type_rev</span><span class="p">)</span>
    <span class="n">set_v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mass_flow</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">setpoint_value</span><span class="p">,</span> <span class="n">setpoint_value_rev</span><span class="p">)</span>

    <span class="c1"># Compute outlet temperature</span>
    <span class="n">t_out</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span> <span class="o">=</span> <span class="n">_compute_hx_outlet_temp</span><span class="p">(</span>
        <span class="n">t_in</span><span class="o">=</span><span class="n">t_in</span><span class="p">,</span>
        <span class="n">mass_flow</span><span class="o">=</span><span class="n">mass_flow</span><span class="p">,</span>
        <span class="n">setpoint_type</span><span class="o">=</span><span class="n">set_t</span><span class="p">,</span>
        <span class="n">setpoint_value</span><span class="o">=</span><span class="n">set_v</span><span class="p">,</span>
        <span class="n">power_max</span><span class="o">=</span><span class="n">power_max</span><span class="p">,</span>
        <span class="n">t_out_min</span><span class="o">=</span><span class="n">t_out_min</span><span class="p">,</span>
        <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
        <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># T_avg is just the average between t_0 and t_1</span>
    <span class="n">t_avg</span> <span class="o">=</span> <span class="n">safe_divide</span><span class="p">(</span><span class="n">t_in</span> <span class="o">+</span> <span class="n">t_out</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Return t_out, t_avg and t_out_der</span>
    <span class="k">return</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span></div>



<div class="viewcode-block" id="compute_hx_temp_net">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_hx_temp_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_hx_temp_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the outlet temperature of a heat exchanger from the inlet</span>
<span class="sd">    temperature based on the given HX type.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get HX attributes</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;mass_flow&quot;</span><span class="p">,</span>
        <span class="s2">&quot;power_max_hx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;t_out_min_hx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;setpoint_type_hx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;setpoint_value_hx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;setpoint_type_hx_rev&quot;</span><span class="p">,</span>
        <span class="s2">&quot;setpoint_value_hx_rev&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stepsize&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="p">(</span>
        <span class="n">edges</span><span class="p">,</span>
        <span class="n">mass_flow</span><span class="p">,</span>
        <span class="n">power_max</span><span class="p">,</span>
        <span class="n">t_out_min</span><span class="p">,</span>
        <span class="n">setpoint_type</span><span class="p">,</span>
        <span class="n">setpoint_value</span><span class="p">,</span>
        <span class="n">setpoint_type_rev</span><span class="p">,</span>
        <span class="n">setpoint_value_rev</span><span class="p">,</span>
        <span class="n">stepsize</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Get temperature at startnode and endnode of HX</span>
    <span class="n">nodes</span><span class="p">,</span> <span class="n">t_nodes</span> <span class="o">=</span> <span class="n">net</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;temperature&quot;</span><span class="p">)</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">T</span>
    <span class="n">nodes_t_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">t_nodes</span><span class="p">))</span>
    <span class="n">t_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">nodes_t_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">u</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">t_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromiter</span><span class="p">((</span><span class="n">nodes_t_dict</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">v</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">t_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mass_flow</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">t_0</span><span class="p">,</span> <span class="n">t_1</span><span class="p">)</span>

    <span class="c1"># Get fluid properties at inlet temperature</span>
    <span class="n">cp_fluid</span> <span class="o">=</span> <span class="n">fluid</span><span class="o">.</span><span class="n">get_cp</span><span class="p">(</span><span class="n">t_in</span><span class="p">)</span>

    <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span> <span class="o">=</span> <span class="n">compute_hx_temp</span><span class="p">(</span>
        <span class="n">mass_flow</span><span class="o">=</span><span class="n">mass_flow</span><span class="p">,</span>
        <span class="n">t_in</span><span class="o">=</span><span class="n">t_in</span><span class="p">,</span>
        <span class="n">setpoint_type</span><span class="o">=</span><span class="n">setpoint_type</span><span class="p">,</span>
        <span class="n">setpoint_type_rev</span><span class="o">=</span><span class="n">setpoint_type_rev</span><span class="p">,</span>
        <span class="n">setpoint_value</span><span class="o">=</span><span class="n">setpoint_value</span><span class="p">,</span>
        <span class="n">setpoint_value_rev</span><span class="o">=</span><span class="n">setpoint_value_rev</span><span class="p">,</span>
        <span class="n">power_max</span><span class="o">=</span><span class="n">power_max</span><span class="p">,</span>
        <span class="n">t_out_min</span><span class="o">=</span><span class="n">t_out_min</span><span class="p">,</span>
        <span class="n">cp_fluid</span><span class="o">=</span><span class="n">cp_fluid</span><span class="p">,</span>
        <span class="n">stepsize</span><span class="o">=</span><span class="n">stepsize</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">t_in</span><span class="p">,</span> <span class="n">t_out</span><span class="p">,</span> <span class="n">t_avg</span><span class="p">,</span> <span class="n">t_out_der</span><span class="p">,</span> <span class="n">delta_q</span></div>



<span class="c1"># --------                Base Consumer and Producer                 -------- #</span>


<div class="viewcode-block" id="compute_cons_temp_net">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_cons_temp_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_cons_temp_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compute_hx_temp_net</span><span class="p">(</span>
        <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="o">=</span><span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="o">=</span><span class="n">soil</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">consumers_mask</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="n">ts_id</span>
    <span class="p">)</span></div>



<div class="viewcode-block" id="compute_prod_temp_net">
<a class="viewcode-back" href="../../../generated/pydhn.components.base_components_thermal.html#pydhn.components.base_components_thermal.compute_prod_temp_net">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_prod_temp_net</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compute_hx_temp_net</span><span class="p">(</span>
        <span class="n">net</span><span class="o">=</span><span class="n">net</span><span class="p">,</span> <span class="n">fluid</span><span class="o">=</span><span class="n">fluid</span><span class="p">,</span> <span class="n">soil</span><span class="o">=</span><span class="n">soil</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">net</span><span class="o">.</span><span class="n">producers_mask</span><span class="p">,</span> <span class="n">ts_id</span><span class="o">=</span><span class="n">ts_id</span>
    <span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Idiap Research Institute, https://www.idiap.ch, EPFL, https://www.epfl.ch.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>